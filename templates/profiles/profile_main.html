{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container main-content">
    <div class="profile-box">
        <img src="{{ user.profile.image.url }}" class="rounded-circle profile-img" alt="프로필 사진">
        <div class="profile-info">    
            <div class="profile-name">
                <p>{{ user.nickname }}의 여행일기<p>
                <div class="position-relative">
                    <!-- 편집 버튼 -->
                    <button id="edit-button">
                        <img src="{% static 'images/편집-평소.png' %}" alt="편집 버튼">
                    </button>
                    <!-- 드롭다운 -->
                    <div class="edit-dropdown p-4 bg-light rounded" id="edit-dropdown">
                            <!-- 닉네임 수정 폼 -->
                            <form class="name-edit-A" method="post" action="{% url 'profiles:edit_nickname' %}">
                                {% csrf_token %}
                                <input type="text" class="form-control" id="nickname" name="nickname" placeholder="새로운 닉네임 입력" required>
                                <button type="submit" class="btn btn-primary">닉네임 저장</button>
                            </form>
                            <!-- 프로필 사진 수정 폼 -->
                            <form class="edit-photo-B" method="post" action="{% url 'profiles:edit_profile_image' %}" enctype="multipart/form-data">
                                {% csrf_token %}
                                <input type="file" class="form-control" id="profile_image" name="profile_image" accept="image/*">
                                <button type="submit" class="btn btn-primary">사진 저장</button>
                            </form>
                    </div>
                </div>
            </div>
        
            <div class="profile-btn">
                <!-- 친구 수 및 드롭다운 -->
                <div class="profile-btn friends-dropdown position-relative">
                    <button class="friends btn-outline-info">
                        친구 <span id="friend-n">{{ friends_count }}</span>명
                    </button>
                    <div class="please friends-list shadow p-3 bg-light rounded">
                        {% if friends %}
                            <ul class="list-unstyled">
                                {% for friend in friends %}
                                <li class="">
                                    <a href="{% url 'profiles:friend_profile' friend.username %}" class="text-decoration-none">
                                        {{ friend.nickname|default:friend.username }} (@{{ friend.username }})
                                    </a>
                                </li>
                                <hr>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>아직 친구가 없습니다.</p>
                        {% endif %}
                    </div>
                </div>

                <div class="locaton-mapping">
                    <button class="map">
                        여행지도 <span id="map-n">7</span>핀
                    </button>
                </div>

                    <!-- 찜한 항목 드롭다운 -->
                <div class="jjim-dropdown">
                    <button class="jjim btn btn-outline-success">
                        찜한 항목 
                        <span id="jjim-n">
                            {{ festival_bookmarks.count|add:travel_bookmarks.count|add:post_bookmarks.count }}
                        </span>
                        개
                    </button>
                    <div class="wishlist-list shadow p-4 bg-light rounded">
                        <!-- 찜한 게시글 목록 -->
                        {% if post_bookmarks %}
                            <ul class="list-unstyled">
                                {% for bookmark in post_bookmarks %}
                                    <li>
                                        <strong id="pptitle">{{ bookmark.post.title }}</strong><br>
                                        <p id="author">{{ bookmark.post.author.username }}</p>
                                        <p id="datedate">{{ bookmark.post.created_at|date:"Y년 m월 d일 H:i" }}</p>
                                    </li>
                                    <hr>
                                {% endfor %}
                            </ul>
                        {% else %}
                            <p>찜한 게시글이 없습니다.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="post-list mt-4">
        <h2 class="mb-4">임시 저장된 글</h2>
        <div class="post-grid" id="post-grid-imshi">
            <!-- 임시 저장된 글 내용들이 여기에 동적으로 삽입됩니다. -->
            {% for post in draft_posts %}
                <div class="post-card mb-4 grid-item">
                    <h3>{{ post.title }}</h3>
                    <p>위치: {{ post.location|default:"위치 정보 없음" }}</p>
                    <p>임시 저장 날짜: {{ post.updated_at|date:"Y년 m월 d일 H:i" }}</p>
    
                    <!-- 수정 버튼 -->
                    <a href="{% url 'posts:post_update' post.pk %}" class="btn btn-sm btn-outline-primary">게시</a>
                    <!-- 삭제 버튼 -->
                    <form method="post" action="{% url 'posts:post_delete' post.pk %}" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>
                    </form>
                </div>
            {% endfor %}
        </div>
    
        <!-- 슬라이드 네비게이션 화살표 -->
        
        <button class="left-arrow" id="prev-btn-imshi" disabled>◀</button>
        <span class="slide-count" id="slide-count-imshi">1/{{ totalPages }}</span> <!-- 슬라이드 카운트 -->
        <button class="right-arrow" id="next-btn-imshi">▶</button>

    </div>
    
    <hr class="my-5">
    
    <div class="post-list mt-4">
        <!-- 내가 쓴 글 -->
        <h2 class="mb-4">내가 쓴 글</h2>
        <div class="post-grid" id="post-grid">
            {% if posts %}
                {% for post in posts %}
                    <div class="post-card mb-4 grid-item">
                        <a href="{% url 'posts:post_detail' post.pk %}" class="text-decoration-none h-pm-url">
                            {{ post.title }}
                        </a>
                        <p>위치: {{ post.location|default:"위치 정보 없음" }}</p>
                        <p>작성 날짜: {{ post.created_at|date:"Y년 m월 d일 H:i" }}</p>
        
                        <!-- 별점 표시 -->
                        <p>별점: 
                            {% for i in "123" %}
                                <span class="{% if i <= post.rating|stringformat:"i" %}text-warning{% else %}text-muted{% endif %}">★</span>
                            {% endfor %}
                        </p>
        
                        <!-- 게시글 수정 및 삭제 버튼 -->
                        {% if post.author == user %}
                            <div class="mt-3">
                                <a href="{% url 'posts:post_update' post.pk %}" class="btn btn-sm btn-outline-primary">수정</a>
                                <form method="post" action="{% url 'posts:post_delete' post.pk %}" style="display:inline;">
                                    {% csrf_token %}
                                    <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('정말 삭제하시겠습니까?')">삭제</button>
                                </form>
                            </div>
                        {% endif %}
                    </div>
                {% endfor %}
            {% else %}
                <p>아직 작성된 게시글이 없습니다.</p>
            {% endif %}
        </div>

        <button class="left-arrow" id="prev-btn" disabled>◀</button>
        <span class="slide-count" id="slide-count">1/{{ totalPages }}</span> <!-- 슬라이드 카운트 -->
        <button class="right-arrow" id="next-btn">▶</button>
    
    </div>

    <div class="mt-4">
        <a href="{% url 'accounts:logout' %}" class="btn btn-danger">로그아웃</a>
    </div>
</div>




<script>
    document.addEventListener('DOMContentLoaded', function () {
        const editButton = document.getElementById('edit-button');
        const editDropdown = document.getElementById('edit-dropdown');
    
        // 버튼 클릭 시 드롭다운 표시 토글
        editButton.addEventListener('click', function () {
            const isHidden = editDropdown.style.display === 'none' || editDropdown.style.display === '';
            editDropdown.style.display = isHidden ? 'block' : 'none';
        });
    
        // 드롭다운 외부 클릭 시 닫기
        document.addEventListener('click', function (event) {
            if (!editDropdown.contains(event.target) && !editButton.contains(event.target)) {
                editDropdown.style.display = 'none';
            }
        });
    });

    document.addEventListener('DOMContentLoaded', () => {
        const itemsPerPage = 3; // 한 페이지에 보여줄 그리드 항목 수 (1줄에 3개)
    
        // 임시 저장된 글 관련 처리
        const gridsImshi = document.querySelector('#post-grid-imshi');
        const leftArrowImshi = document.querySelector('#prev-btn-imshi');
        const rightArrowImshi = document.querySelector('#next-btn-imshi');
        const slideCountImshi = document.querySelector('#slide-count-imshi');
        const postsImshi = document.querySelectorAll('#post-grid-imshi .grid-item'); // 임시 저장된 글
        let currentSlideImshi = 0;
        const totalPostsImshi = postsImshi.length;
        const totalPagesImshi = Math.ceil(totalPostsImshi / itemsPerPage);
    
        // 출간된 글 관련 처리
        const grids = document.querySelector('#post-grid');
        const leftArrow = document.querySelector('#prev-btn');
        const rightArrow = document.querySelector('#next-btn');
        const slideCount = document.querySelector('#slide-count');
        const posts = document.querySelectorAll('#post-grid .grid-item'); // 출간된 글
        let currentSlide = 0;
        const totalPosts = posts.length;
        const totalPages = Math.ceil(totalPosts / itemsPerPage);
    
        // 슬라이드 페이지 카운트를 표시하는 함수
        function updateSlideCount(slideCount, currentSlide, totalPages) {
            const currentPage = Math.floor(currentSlide / itemsPerPage) + 1;
            slideCount.textContent = `${currentPage}/${totalPages}`;
        }
    
        // 슬라이드 그리드 업데이트 함수
        function updateGridRow(grids, posts, currentSlide) {
            const visiblePosts = Array.from(posts).slice(currentSlide, currentSlide + itemsPerPage);
            grids.innerHTML = ''; // 기존 그리드 내용 초기화
            visiblePosts.forEach(post => {
                grids.appendChild(post);
            });
        }
    
        // 임시 저장된 글 그리드 업데이트
        function updateImshiGrid() {
            updateGridRow(gridsImshi, postsImshi, currentSlideImshi);
            updateSlideCount(slideCountImshi, currentSlideImshi, totalPagesImshi);
    
            leftArrowImshi.disabled = currentSlideImshi === 0;
            rightArrowImshi.disabled = currentSlideImshi + itemsPerPage >= totalPostsImshi;
        }
    
        // 출간된 글 그리드 업데이트
        function updatePublishedGrid() {
            updateGridRow(grids, posts, currentSlide); // 여기서 posts를 그리드에 맞게 업데이트
            updateSlideCount(slideCount, currentSlide, totalPages);
    
            leftArrow.disabled = currentSlide === 0;
            rightArrow.disabled = currentSlide + itemsPerPage >= totalPosts;
        }
    
        // 임시 저장된 글 왼쪽 화살표 클릭 이벤트
        leftArrowImshi.addEventListener('click', () => {
            if (currentSlideImshi > 0) {
                currentSlideImshi -= itemsPerPage;
                updateImshiGrid();
            }
        });
    
        // 임시 저장된 글 오른쪽 화살표 클릭 이벤트
        rightArrowImshi.addEventListener('click', () => {
            if (currentSlideImshi + itemsPerPage < totalPostsImshi) {
                currentSlideImshi += itemsPerPage;
                updateImshiGrid();
            }
        });
    
        // 출간된 글 왼쪽 화살표 클릭 이벤트
        leftArrow.addEventListener('click', () => {
            if (currentSlide > 0) {
                currentSlide -= itemsPerPage;
                updatePublishedGrid();
            }
        });
    
        // 출간된 글 오른쪽 화살표 클릭 이벤트
        rightArrow.addEventListener('click', () => {
            if (currentSlide + itemsPerPage < totalPosts) {
                currentSlide += itemsPerPage;
                updatePublishedGrid();
            }
        });
    
        // 초기 그리드 표시
        updateImshiGrid(); // 임시 저장된 글 그리드 초기화
        updatePublishedGrid(); // 출간된 글 그리드 초기화
    });
</script>


<style>
    /* 기본 설정 */
    @font-face {
      font-family: 'SchoolSafeFont';
      src: url('{%static "fonts/HakgyoansimYeohaengR.ttf" %}') format('truetype');
    }
    .h-pm-url {
        color: black !important;
        font-size: 20px;
    }
    .container {
        width: 90%;
        height:100%;
        max-width: 1400px;
        margin-top: 20px;
        padding: 5px;
        margin-bottom: 0px;
        display: flex;
        flex-direction: column;
    }


    .profile-box {
        align-items: center;
        display: flex;
        justify-content:center;
    }
    
    .profile-img {
        width: 200px;
        height: 200px; /* 고정 크기 */
        border-radius: 50%;
        border: 5px solid #508344;
        margin-right:50px;
    }
    
    .profile-info {
        display: flex;
        flex-direction: column;
        margin-left:50px;
    }
    .profile-name{
        display: flex;
        align-items: center;
        gap: 5px;
    }
    .profile-name > p {
        font-family: 'SchoolSafeFont';
        font-size: 53px;
        color: #508344;
        margin:0;
    }
    
    .profile-name button{
        background:none;

    }

    .profile-name img {
        width: 70px;
        margin-left: 5px;
        margin-top: 10px;
    }
    
    .profile-name img:hover {
        transform: scale(1.01);
    }
    
    .profile-btn {
        margin-top: 5px;
        display: flex;
        gap: 10px;
        justify-content: space-evenly;
    }
    
    .profile-btn button {
        font-size: 20px;
        background: none;
        color: #508344;
        font-weight: bold;
        border: none;
        margin: 5px 35px;
    }
    
    .friends-list {
        background: linear-gradient(to bottom, #508344, #759C6B);
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* 그림자 */
        max-width: 300px;
        overflow-y:auto;
        height: 200px;
        color:white;
    }
    .profile-btn button:hover {
        color: #3e6b2f;
    }
    
    .profile-btn {
        align-items: center;
    }


    .edit-dropdown {
        position: absolute; /* 부모 요소 기준으로 위치 고정 */
        top: 100%; /* 버튼 바로 아래에 배치 */
        right: 0; /* 부모 요소 오른쪽 정렬 */
        z-index: 1000; /* 다른 요소 위에 표시 */
        display: none; /* 초기에는 숨김 */
        background: linear-gradient(to bottom, #508344, #759C6B);
        color: white;
        border: 1px solid #ccc; /* 테두리 */
        border-radius: 5px; /* 모서리 둥글게 */
        padding: 15px; /* 여백 */
        width: 450px; /* 드롭다운 너비 */
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1); /* 그림자 */
    }
    .edit-dropdown form{
        margin:10px;
    }

    .name-edit-A{
        display:flex;
        align-items:center;
        justify-content:space-evenly;
    }

    .name-edit-A input{
        width: 250px;
        padding: 8px;
        border: 1px solid #ccc;
        font-size: 15px;
        resize: none;
    }
    .name-edit-A button{
        background: linear-gradient(to bottom, #508344, #759C6B);
        color: white;
        border: none;
        padding: 9px;
        cursor: pointer;
        width:128px;
    }

    .name-edit-A button:hover {
        transform:scale(1.01);
        background: linear-gradient(to bottom, #508344, #759C6B);
    }

    
    .edit-photo-B{
        display:flex;
        align-items:center;
        justify-content:space-evenly;
    }
    .edit-photo-B input{
        width: 250px;
        padding: 8px;
        border: 1px solid #ccc;
        font-size: 15px;
        resize: none;
    }
    .edit-photo-B button{
        background: linear-gradient(to bottom, #508344, #759C6B);
        color: white;
        border: none;
        padding: 9px;
        cursor: pointer;
        width:128px;
    }

    .edit-photo-B button:hover {
        transform:scale(1.01);
        background: linear-gradient(to bottom, #508344, #759C6B);
    }

    .btn-outline-secondary {
        cursor: pointer;
    }
    .friends-dropdown {
        position: relative;
        display: inline-block;
    }
    .friends-list {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 200px;
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
    }
    .friends-dropdown:hover .friends-list {
        display: block;
    }

    .text-decoration-none {
        font-family: 'SchoolSafeFont';
        color: #FDF3D4;
    }
    
    .text-warning {
        color: gold;
    }
    .text-muted {
        color: gray;
    }
    .jjim-dropdown {
        position: relative;
        display: inline-block;
    }
    .wishlist-list {
        display: none;
        position: absolute;
        top: 100%;
        left: 0;
        width: 350px;
        height: 300px;
        overflow-y:auto;
        background: linear-gradient(to bottom, #508344, #759C6B);
        border-radius: 8px;
        padding: 20px;
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        z-index: 10;
        color:white;
    }
    .jjim-dropdown:hover .wishlist-list {
        display: block;
    }
    .jjim-dropdown button:hover{
        background: none;
    }
    .wishlist-list ul {
        padding-left: 0;

    }
    .wishlist-list li {
        font-family: 'SchoolSafeFont';
        padding:1px;
        margin-bottom: 5px;        
        background-color: rgba(255,255,255,0.6);
        border-radius:5px;
    }
    #pptitle{
        font-size:18px;
        color: #FDF3D4;
    }
    #author, #datedate{
        font-size:15px;
        color: #757575;
        margin:0;
    }
    hr {
        border: 0.5px solid #ddd;
    }

    .post-grid {
        display: grid;
        grid-template-columns: repeat(3, 1fr); /* 한 줄에 3개씩 */
        gap: 20px;
        margin-bottom: 20px;
    }
    
    .post-card {
        background-color: #fff;
        border: 1px solid #ddd;
        padding: 15px;
        border-radius: 5px;
    }
    
    .pagination {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-top: 20px;
    }
    
    .pagination button {
        background-color: #007bff;
        color: white;
        padding: 5px 15px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
    }
    
    .pagination button:hover {
        background-color: #0056b3;
    }
    
    #page-num {
        font-size: 1.2rem;
    }


</style>
{% endblock content %}

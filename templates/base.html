{% load static %}
<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">  
    {% block head %}{% endblock %}
</head>
<body>
    <main>
        <div class="menu-bar">
            <div class="dropdown">
                <h4>ì „ì²´ë³´ê¸°</h4>
                <div class="dropdown-content">
                    <!-- ì§€ì—­ ì¶•ì œ ì •ë³´ í˜ì´ì§€ë¡œ ì´ë™ -->
                    <a href="{% url 'places:festival_list' %}">ì§€ì—­ì¶•ì œ ì •ë³´</a><br>
                    
                    <!-- êµ­ë‚´ ì—¬í–‰ì§€ ì •ë³´ í˜ì´ì§€ë¡œ ì´ë™ -->
                    <a href="{% url 'places:travel_list' %}">êµ­ë‚´ ì—¬í–‰ì§€ ì •ë³´</a><br>
                    
                    <!-- ë‚¨ì˜ ì—¬í–‰ì¼ê¸° í˜ì´ì§€ë¡œ ì´ë™ -->
                    <a href="{% url 'posts:post_list' %}">ë‚¨ì˜ ì—¬í–‰ì¼ê¸°</a><br>
                    <p>ì¹œêµ¬ì˜ ì—¬í–‰ì¼ê¸°</p>
                </div>
            </div>

            <!-- ì¹œêµ¬ ì¶”ê°€ ë“œë¡­ë‹¤ìš´ -->
        <div class="dropdown">
            <h4>ì¹œêµ¬ì¶”ê°€</h4>
            <div class="dropdown-content search-box">
                <form id="friend-search-form" method="post" action="{% url 'accounts:search_user' %}">
                    {% csrf_token %}
                    <input type="text" id="friend-search-input" name="user_id" placeholder="ì¹œêµ¬ ê²€ìƒ‰" class="search-input" required>
                    <button type="submit" class="btn btn-primary mt-2">ê²€ìƒ‰</button>
                </form>

                <!-- ê²€ìƒ‰ ê²°ê³¼ í‘œì‹œ ì˜ì—­ -->
                <div id="search-result" class="mt-3"></div>
            </div>
        </div>


            <h4>ì°œí•œì—¬í–‰</h4>
            <a href="{% url 'posts:main' %}"><h4>ì—¬í–‰ ë‹¤ì›€</h4></a>
            <a href="{% url 'posts:post_create' %}"><span class="menu-item">ì—°í•„</span></a>
            <!-- ì¹œêµ¬ ìš”ì²­ ì•Œë¦¼ ë“œë¡­ë‹¤ìš´ -->
            <span class="menu-item dropdown">
                <span class="menu-icon" onclick="toggleRequests()">ğŸ””</span> <!-- ì¢… ì•„ì´ì½˜ -->
                <div class="dropdown-content friend-requests" id="friend-requests-dropdown" style="display: none;">
                    <h4>ì¹œêµ¬ ìš”ì²­</h4>
                    <div id="friend-requests-container">
                        <!-- AJAXë¡œ ì¹œêµ¬ ìš”ì²­ ëª©ë¡ì„ ê°€ì ¸ì™€ì„œ í‘œì‹œí•  ë¶€ë¶„ -->
                    </div>
                </div>
            </span>


            <!-- ì˜¤ë¥¸ìª½ ìƒë‹¨ ë“œë¡­ë‹¤ìš´ ë©”ë‰´ -->
            <div class="dropdown">
                {% if user.is_authenticated %}
                    <!-- ë¡œê·¸ì¸ëœ ì‚¬ìš©ìì˜ ì •ë³´ í‘œì‹œ -->
                    <a href="{% url 'profiles:profile_main' %}"><span class="dropdown-button">{{ user.username }}</span></a>
                    <div class="dropdown-content">
                        <p>ë‹‰ë„¤ì„: {{ user.nickname }}</p>
                        <p>ì•„ì´ë””: {{ user.username }}</p>
                        <a href="{% url 'accounts:logout' %}" class="btn btn-secondary">ë¡œê·¸ì•„ì›ƒ</a>
                    </div>
                {% else %}
                    <!-- ë¡œê·¸ì¸ í¼ í‘œì‹œ -->
                    <span class="dropdown-button">ë¡œê·¸ì¸</span>
                    <div class="dropdown-content">
                        <form method="post" action="{% url 'accounts:login' %}">
                            {% csrf_token %}
                            <h3>ë¡œê·¸ì¸</h3>
                            <label for="username">ì•„ì´ë””</label>
                            <input type="text" id="username" name="username" required>

                            <label for="password">ë¹„ë°€ë²ˆí˜¸</label>
                            <input type="password" id="password" name="password" required>

                            <button type="submit" class="btn btn-primary">ë¡œê·¸ì¸</button>
                        </form>
                        <a href="{% url 'accounts:signup' %}">
                            <button class="btn btn-secondary">íšŒì›ê°€ì…</button>
                        </a>
                    </div>
                {% endif %}
            </div>
        </div>
        {% block content %}{% endblock %}
    </main>
</body>
</html>


<script>
document.getElementById('friend-search-form').addEventListener('submit', function(event) {
    event.preventDefault();

    const input = document.getElementById('friend-search-input');
    const resultDiv = document.getElementById('search-result');
    const csrfToken = document.querySelector('[name=csrfmiddlewaretoken]').value;

    fetch("{% url 'accounts:search_user' %}", {
        method: 'POST',
        headers: {
            'Content-Type': 'application/x-www-form-urlencoded',
            'X-CSRFToken': csrfToken
        },
        body: new URLSearchParams({ user_id: input.value })
    })
    .then(response => response.json())
    .then(data => {
        resultDiv.innerHTML = '';
        if (data.error) {
            resultDiv.innerHTML = `<p class="text-danger">${data.error}</p>`;
        } else {
            // ê²€ìƒ‰ëœ ì‚¬ìš©ìê°€ ìˆì„ ê²½ìš° í”„ë¡œí•„ í˜ì´ì§€ ë§í¬ ì¶”ê°€
            let profileLink = `<a href="/profiles/${data.username}/" class="btn btn-info">í”„ë¡œí•„ ë³´ê¸°</a>`;
            
            // ì´ë¯¸ ì¹œêµ¬ì¸ ê²½ìš° ì¶”ê°€ ë²„íŠ¼ì„ í‘œì‹œí•˜ì§€ ì•ŠìŒ
            let friendRequestButton = data.is_friend ? '' : `
                <form method="post" action="/accounts/send_request/${data.user_id}/">
                    {% csrf_token %}
                    <button type="submit" class="btn btn-success mt-2">ì¹œêµ¬ ìš”ì²­ ë³´ë‚´ê¸°</button>
                </form>
            `;

            resultDiv.innerHTML = `
                <p>ì•„ì´ë””: ${data.username}</p>
                ${profileLink}
                ${friendRequestButton}
            `;
        }
    })
    .catch(error => {
        console.error('Error:', error);
        resultDiv.innerHTML = '<p class="text-danger">ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.</p>';
    });
});

    function toggleRequests() {
    const dropdown = document.getElementById('friend-requests-dropdown');
    dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    loadFriendRequests(); // ì¹œêµ¬ ìš”ì²­ ëª©ë¡ ë¶ˆëŸ¬ì˜¤ê¸°
}

function loadFriendRequests() {
    fetch("{% url 'accounts:get_friend_requests' %}")
    .then(response => response.json())
    .then(data => {
        const container = document.getElementById('friend-requests-container');
        container.innerHTML = '';
        
        if (data.requests.length === 0) {
            container.innerHTML = '<p>ë°›ì€ ì¹œêµ¬ ìš”ì²­ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
        } else {
            data.requests.forEach(req => {
                const requestElement = document.createElement('div');
                requestElement.classList.add('friend-request-item');
                requestElement.innerHTML = `
                    <p>${req.from_user_nickname} (@${req.from_user})ë‹˜ì˜ ì¹œêµ¬ ìš”ì²­</p>
                    <button class="btn btn-success" onclick="handleRequest(${req.id}, 'accept')">ìˆ˜ë½</button>
                    <button class="btn btn-danger" onclick="handleRequest(${req.id}, 'decline')">ê±°ì ˆ</button>
                `;
                container.appendChild(requestElement);
            });
        }
    });
}

function handleRequest(requestId, action) {
    const url = action === 'accept'
        ? "{% url 'accounts:accept_friend_request' 0 %}".replace('0', requestId)
        : "{% url 'accounts:decline_friend_request' 0 %}".replace('0', requestId);

    fetch(url, { method: 'POST', headers: { 'X-CSRFToken': '{{ csrf_token }}' } })
    .then(response => response.json())
    .then(data => {
        if (data.status === 'accepted' || data.status === 'declined') {
            loadFriendRequests(); // ì¹œêµ¬ ìš”ì²­ ëª©ë¡ ê°±ì‹ 
        }
    });
}

document.addEventListener('DOMContentLoaded', loadFriendRequests);
</script>
    
    
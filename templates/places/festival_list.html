{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2>지역 축제 정보 <span class="text-muted">총 {{ festival_count }}건</span></h2>
    
    <div class="row mt-4">
        {% if festivals %}
            {% for festival in festivals %}
            <div class="col-md-4 mb-4">
                <div class="card shadow-sm">
                    {% if festival.image %}
                    <img src="{{ festival.image.url }}" class="card-img-top custom-img" alt="{{ festival.name }}">
                    {% else %}
                    <img src="{% static 'images/default_festival.jpg' %}" class="card-img-top custom-img" alt="{{ festival.name }}">
                    {% endif %}
                    
                    <div class="card-body">
                        <h5 class="card-title">{{ festival.name }}</h5>
                        <p>{{ festival.description|truncatewords:20 }}</p>
                        <p><strong>장소:</strong> {{ festival.location }}</p>
                        <p><strong>기간:</strong> {{ festival.start_date }} ~ {{ festival.end_date }}</p>
                        <p><strong>남은 일수:</strong> <span class="badge bg-primary">{{ festival.days_left }}</span></p>
                        
                        <!-- 찜 버튼 -->
                        <button class="btn bookmark-btn {% if festival.is_bookmarked %}btn-primary{% else %}btn-outline-primary{% endif %}" 
                        data-festival-id="{{ festival.id }}" 
                        data-url="{% url 'places:toggle_bookmark' festival.id %}">
                        {% if festival.is_bookmarked %}찜 취소{% else %}찜하기{% endif %}
                        </button>

                    </div>
                </div>
            </div>
            {% endfor %}
        {% else %}
            <p>현재 등록된 축제가 없습니다.</p>
        {% endif %}
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function() {
        const buttons = document.querySelectorAll('.bookmark-btn');
    
        buttons.forEach(button => {
            button.addEventListener('click', function() {
                const url = this.getAttribute('data-url');
                const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
    
                fetch(url, {
                    method: 'POST',
                    headers: {
                        'X-CSRFToken': csrftoken,
                        'Content-Type': 'application/json',
                    }
                })
                .then(response => {
                    if (!response.ok) {
                        throw new Error('Network response was not ok');
                    }
                    return response.json();
                })
                .then(data => {
                    if (data.is_bookmarked) {
                        this.textContent = '찜 취소';
                        this.classList.remove('btn-outline-primary');
                        this.classList.add('btn-primary');
                    } else {
                        this.textContent = '찜하기';
                        this.classList.remove('btn-primary');
                        this.classList.add('btn-outline-primary');
                    }
                })
                .catch(error => console.error('There was an error:', error));
            });
        });
    });
</script>
    
<style>
    .custom-img {
        width: 100%;
        height: 200px;
        object-fit: cover;
    }
</style>
{% endblock %}
